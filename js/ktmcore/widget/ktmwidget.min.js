"use strict";var Ktm=Ktm||{};Ktm.Widget=Class.create(),Ktm.Widget.prototype={VIDEO_MUTE_BTN_CLASS:"videoMuteBtn fa",VIDEO_MUTE_BTN_CLASS_ON:"fa-volume-up",VIDEO_MUTE_BTN_CLASS_OFF:"fa-volume-off",VIDEO_HW_RATIO:.5625,VENDOR_PREFIXES:"webkit|Moz".split("|"),initialize:function(t,e){this.id=t,this.container=$(t),this.config=e||{},this.checkCSS3Support(),document.observe("dom:loaded",function(){this.initTab(),this.initCountdown(),this.config.carousel&&this.config.carousel.enable?(this.initCarousel(function(t){var e=t.target;this.initCarouselAnimation(e,!0)}.bind(this)),this.initBackground()):(this.initAnimation(),this.initBackground())}.bind(this))},initCountdown:function(){window.jQuery&&this.config.countdown&&this.config.countdown.enable&&(jQuery.fn.countdown?this.bindCountdownEvent():jQuery.getScript(this.config.countdown.engineSrc,function(){this.bindCountdownEvent()}.bind(this)))},bindCountdownEvent:function(){this.container.select(".product-date").each(function(t){var e=t.readAttribute("data-date");if(e){var i={date:e};Object.extend(i,this.config.countdown),Object.extend(i,this.config.countdownConfig),this.config.countdownTemplate&&(i.template=this.config.countdownTemplate),jQuery(t).countdown(i),console.log(jQuery(t))}}.bind(this))},initAnimation:function(){if(window.jQuery&&this.config.animation&&this.config.animation.enable){var t=this.config.animation.animationName,e=this.config.animation.animationDelay;this.container.select(this.config.animation.itemSelector||".item").each(function(i,n){i.addClassName(t+" wow"),i.setStyle({visibility:"hidden"}),i.setAttribute("data-wow-delay",e*n+"ms")}),window.WOW?this.bindWOWEvent():jQuery.getScript(this.config.animation.engineSrc,function(){this.bindWOWEvent()}.bind(this))}},bindWOWEvent:function(){new WOW({animateClass:"active"}).init()},initCarouselAnimation:function(t,e){if(this.config.animation&&this.config.animation.enable){var i=this.config.animation.animationName,n=[];jQuery(t).find(".owl-item").each(function(t,e){var a=$(e);a.addClassName(i),a.hasClassName("active")&&(a.removeClassName("active"),a.setStyle({visibility:"hidden"}),n.push(a))}.bind(this)),e?this.bindAnimateEvent(n):this.animateElements(n)}},bindAnimateEvent:function(t){"DOMContentLoaded|load|resize|scroll".split("|").each(function(e){Event.observe(window,e,function(){!this.animated&&this.isElementInViewport(.5)&&(this.animated=!0,this.animateElements(t))}.bind(this))}.bind(this))},animateElements:function(t){var e=this.config.animation.animationDelay||300;t.each(function(t,i){var n=0==i?0:e*i;this.setVendorCss(t,"animationDelay",n+"ms"),t.addClassName("active"),t.setStyle({visibility:"visible"})}.bind(this)),setTimeout(function(){t.each(function(t){this.setVendorCss(t,"animationDelay","initial")}.bind(this))}.bind(this),(t.length+1)*e)},setVendorCss:function(t,e,i){var n={property:i};this.VENDOR_PREFIXES.each(function(t){n[t+e.charAt(0).toUpperCase()+e.substr(1)]=i}),t.setStyle(n)},checkCSS3Support:function(){var t,e="translate3d(0px, 0px, 0px)",i=new Element("div");i.style.cssText="-moz-transform:"+e+";-ms-transform:"+e+";-o-transform:"+e+";-webkit-transform:"+e+";transform:"+e,t=i.style.cssText.match(/translate3d\(0px, 0px, 0px\)/g),this.support3d=null!==t&&t.length>=1},initTab:function(){this.config.collectionUrl&&this.container.select(".widget-tabs a").each(function(t){var e=this.container.down(t.readAttribute("href"));e&&(e.down("ul")&&(e.has_content=!0),Event.observe(t,"click",function(i){if(Event.stop(i),this.activeTab(t,e),!e.has_content){var n=Event.findElement(i,"a"),a=n.readAttribute("data-type"),o=n.readAttribute("data-value"),s=n.readAttribute("data-limit"),r=n.readAttribute("data-column"),l=n.readAttribute("data-row"),c=n.readAttribute("data-pricePrefixId"),d=n.readAttribute("data-cid"),h=n.readAttribute("data-template"),u=n.readAttribute("data-carousel"),m=Ktm.FORM_KEY||null;new Ajax.Request(this.config.collectionUrl,{method:"post",parameters:{type:a,value:o,limit:s,form_key:m,carousel:u,column:r,cid:d,row:l,pricePrefixId:c,template:h},onSuccess:function(t){e.has_content=!0,e.innerHTML=t.responseText,jQuery('[data-toggle="tooltip"]').tooltip({container:"body"}),jQuery("img.lazy").lazy({bind:"event",effect:"fadeIn",effectTime:800,threshold:250,retinaAttribute:"data-src-retina"}),this.initCarousel(function(t){var i=t.target;this.initCarouselAnimation(i,!1),this.initCountdown(),e.setStyle({height:"auto"})}.bind(this)),this.config.collectionCallback&&this.config.collectionCallback()}.bind(this)})}}.bind(this)))}.bind(this))},activeTab:function(t,e){if(t&&e){if(this.container.select(".widget-tabs .active").invoke("removeClassName","active"),t.up().addClassName("active"),e.has_content)this.container.select(".tab-pane.active").invoke("removeClassName","active");else{var i=this.container.down(".tab-pane.active");if(i){e.setStyle({height:i.getDimensions().height+"px"}),i.removeClassName("active");var n=new Element("div",{"class":"widget-spinner"});if(n.setStyle({width:"100%",height:"100%"}),this.config.spinnerClass&&n.addClassName(this.config.spinnerClass),this.config.spinnerImg){n.setStyle({position:"relative"});var a=new Element("img",{src:this.config.spinnerImg});Event.observe(a,"load",function(){a.setStyle({position:"absolute",top:"50%",left:"50%",marginLeft:-1*a.width/2+"px",marginTop:-1*a.height/2+"px"}),n.insert(a)})}e.insert(n)}}e.addClassName("active")}},initCarousel:function(t){window.jQuery&&this.container&&this.config.carousel&&this.config.carousel.enable&&(t&&(this.config.carousel.onInitialized=t),jQuery.fn.owlCarousel?this.initCarouselElement(this.config.carousel):jQuery.getScript(this.config.carousel.engineSrc,function(){this.initCarouselElement(this.config.carousel)}.bind(this)))},initCarouselElement:function(t){this.config.carouselConfig&&(t=Object.extend(t,this.config.carouselConfig)),this.container.select(".owl-carousel").each(function(e){jQuery(e).owlCarousel(t)})},initBackground:function(){this.config.parallax&&this.config.kenburns&&(this.config.parallax.enable&&this.initParallax(),this.config.kenburns.enable&&this.initKenburns())},initKenburns:function(){window.jQuery&&(jQuery.fn.Kenburns?this.initKenburnsElement(this.config.kenburns):jQuery.getScript(this.config.kenburns.engineSrc,function(){this.initKenburnsElement(this.config.kenburns)}.bind(this)))},initKenburnsElement:function(t){this.initOverlay(),this.container.setStyle({position:"relative",overflow:"hidden"});var e=new Element("div",{"class":"widget-kenburns"});e.setStyle({position:"absolute",width:"100%",height:"100%",zIndex:0}),this.container.insert({top:e}),jQuery(e).Kenburns({images:t.images,scale:1,duration:6e3,fadeSpeed:800})},initOverlay:function(){"none"!=this.config.parallax.overlay&&this.container.insert({top:new Element("div",{"class":"widget-overlay"}).setStyle({position:"absolute",left:0,top:0,width:"100%",height:"100%",backgroundImage:"url("+ktmStores.url+this.config.parallax.overlay+")",backgroundRepeat:"repeat"})})},initParallax:function(){if(this.config.parallax&&this.config.parallax.enable)switch(this.initOverlay(),this.config.parallax.type){case"video":this.initBackgoundVideo(this.config.parallax.video||{});break;case"image":this.initBackgroundImage(this.config.parallax.image||{});break;case"file":this.initBackgroundVideoFile(this.config.parallax.file||{})}},initBackgroundImage:function(t){if(t.src){var e=new Element("div",{"class":"parallax-bg"}).setStyle({backgroundImage:"url("+t.src+")",position:"absolute",width:"100%",height:t.height,backgroundSize:t.fit,backgroundRepeat:t.repeat,backgroundPosition:"center center",top:0,left:0,zIndex:0});this.container.setStyle({position:"relative",overflow:"hidden"}).insert({top:e}),this.bindParallaxEvent(e)}},isElementInViewport:function(t){t=t||1;var e=this.container.getBoundingClientRect(),i=window.innerHeight||document.documentElement.clientHeight;return e.top>0?e.top<i-e.height*t:e.bottom>e.height*t},isElementPartialInViewport:function(){var t=this.container.getBoundingClientRect();return t.bottom>0&&t.bottom<=t.height||t.top>0&&t.top<=(window.innerHeight||document.documentElement.clientHeight)},initBackgroundVideoFile:function(t){var e=this.calculateVideoSize(this.container),i=new Element("video",{preload:"preload",loop:"loop",autoplay:"autoplay",muted:!t.volume,poster:t.poster});i.setStyle({width:"100%",height:e.height+"px",position:"absolute",zIndex:0,top:"0",left:"-1px"}),t.mp4&&i.insert(new Element("source",{src:t.mp4,type:"video/mp4"})),t.webm&&i.insert(new Element("source",{src:t.webm,type:"video/webm"})),this.container.setStyle({position:"relative",overflow:"hidden"}).insert({top:i}),this.bindParallaxEvent(i)},onParallaxEvent:function(t){if(this.isElementPartialInViewport()){var e=window.innerHeight||document.documentElement.clientHeight,i=this.container.getBoundingClientRect(),n=t.getDimensions(),a=e+i.height,o=n.height-i.height,s=o/a,r=Math.floor((i.top-e)*s);this.support3d?t.setStyle({"-webkit-transform":"translate3d(0px,"+r+"px,0px)","-moz-transform":"translate3d(0px,"+r+"px,0px)","-ms-transform":"translate3d(0px,"+r+"px,0px)","-o-transform":"translate3d(0px,"+r+"px,0px)",transform:"translate3d(0px,"+r+"px,0px)"}):t.setStyle({marginTop:r+"px"})}},bindParallaxEvent:function(t){"DOMContentLoaded|load|resize|scroll|video:load".split("|").each(function(e){Event.observe(window,e,function(){this.onParallaxEvent(t)}.bind(this))}.bind(this))},initBackgoundVideo:function(t){t.src.indexOf("youtube.com")>0?this.initBackgoundVideoYoutube(t):t.src.indexOf("vimeo.com")>0&&this.initBackgoundVideoVimeo(t),Event.observe(window,"resize",function(){var t=this.calculateVideoSize(this.container),e=parent.down("iframe");e&&e.setStyle({height:t.height+"px",top:-1*t.top+"px"})}.bind(this))},getVideoIdVimeo:function(t){return t?t.replace(/[^0-9]+/g,""):null},getVideoIdYoutube:function(t){var e=t.split("v=")[1];return e?e.indexOf("&")>0?e.substring(0,e.indexOf("&")):e:null},onYoutubePlayerReady:function(t){return this.player&&this.player.mute?(t.volume||this.player.mute(),this.bindParallaxEvent(this.player.a),Event.fire(window,"video:load"),this.player):setTimeout(function(){this.onYoutubePlayerReady(t)}.bind(this),500)},onYoutubeAPIReady:function(t,e){if(!window.YT.Player)return setTimeout(function(){this.onYoutubeAPIReady(t,e)}.bind(this),500);var i=this.calculateVideoSize(this.container),n=this.id+"-player",a=new Element("div",{id:n}),o=this.addVideoMuteButton(this.container,!e.volume);Event.observe(o,"click",function(t){if(this.player){var e=Event.element(t);this.player.isMuted()?(this.player.unMute(),e.addClassName(this.VIDEO_MUTE_BTN_CLASS_ON),e.removeClassName(this.VIDEO_MUTE_BTN_CLASS_OFF)):(e.addClassName(this.VIDEO_MUTE_BTN_CLASS_OFF),e.removeClassName(this.VIDEO_MUTE_BTN_CLASS_ON),this.player.mute())}}.bind(this)),a.setStyle({position:"absolute",zIndex:0,top:0}),this.container.setStyle({position:"relative",overflow:"hidden"});var s=$(this.id+"-overlay");return s?s.insert({before:a}):this.container.insert({top:a}),this.player=new YT.Player(n,{height:i.height,width:"100%",videoId:t,playerVars:{autoplay:1,autohide:1,controls:0,loop:1,showinfo:1,wmode:"transparent",html5:1,rel:0,playlist:t},events:{onReady:this.onYoutubePlayerReady.call(this,e)}})},initBackgoundVideoYoutube:function(t){var e=this.getVideoIdYoutube(t.src);e&&window.jQuery&&(window.YT?this.onYoutubeAPIReady(e,t):jQuery.getScript("//www.youtube.com/iframe_api",function(){this.onYoutubeAPIReady(e,t)}.bind(this)))},initBackgoundVideoVimeo:function(t){var e=this.getVideoIdVimeo(t.src);if(e){var i="//player.vimeo.com/video/"+e+"?title=0&byline=0&portrait=0&autoplay=1&loop=1&api=1",n=this.addVideoMuteButton(this.container,!t.volume),a=this.calculateVideoSize(this.container),o=new Element("iframe",{id:this.id+"-player",src:i,frameborder:0,allowfullscreen:1,height:a.height+"px",width:"100%"}).setStyle({position:"absolute",left:0,zIndex:0,top:0});this.container.setStyle({position:"relative",overflow:"hidden"});var s=$(this.id+"-overlay");s?s.insert({before:o}):this.container.insert({top:o}),this.player=o,Event.observe(n,"click",function(t){if(this.player){var e,i=Event.element(t);this.player.muted?(e=0,this.player.muted=1,i.addClassName(this.VIDEO_MUTE_BTN_CLASS_OFF),i.removeClassName(this.VIDEO_MUTE_BTN_CLASS_ON)):(e=1,this.player.muted=0,i.addClassName(this.VIDEO_MUTE_BTN_CLASS_ON),i.removeClassName(this.VIDEO_MUTE_BTN_CLASS_OFF)),this.postmessage(this.player,"setVolume",e)}}.bind(this)),Event.observe(window,"message",function(e){if(this.player){var i=JSON.parse(e.data);switch(i.event){case"ready":this.postmessage(this.player,"addEventListener","play");break;case"play":t.volume?this.player.muted=0:(this.postmessage(this.player,"setVolume",0),this.player.muted=1),Event.fire(window,"video:load")}}}.bind(this)),this.bindParallaxEvent(o)}},calculateVideoSize:function(t){var e=$(t),i=e.getDimensions(),n=parseInt(i.width*this.VIDEO_HW_RATIO),a=n>i.height?parseInt((n-i.height)/2):0;return{height:n,top:a}},addVideoMuteButton:function(t,e){var i=$(t);if(!i)return null;var n=new Element("i",{"class":this.VIDEO_MUTE_BTN_CLASS,href:"javascript:void(0)"});return e?n.addClassName(this.VIDEO_MUTE_BTN_CLASS_OFF):n.addClassName(this.VIDEO_MUTE_BTN_CLASS_ON),i.insert({bottom:n}),n},postmessage:function(t,e,i){var n={method:e};null!=i&&(n.value=i),t.contentWindow.postMessage(JSON.stringify(n),t.src.split("?")[0])}};